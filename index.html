<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guide Gourmand Nancy</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        #map { height: 100%; width: 100%; z-index: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 10px; }
        
        body { height: 100dvh; overflow: hidden; touch-action: none; }
        .app-container { height: 100dvh; display: flex; flex-direction: column; }
        
        .cat-btn.active { background-color: white; color: #d97706; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .cat-btn { opacity: 0.9; }

        /* Custom Tooltip Styles for Leaflet */
        .leaflet-tooltip.custom-tooltip {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 4px 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 11px;
            font-weight: 700;
            color: #334155;
            line-height: 1.4;
            white-space: nowrap;
            transform: translateY(-8px);
        }
        /* Hide arrows */
        .leaflet-tooltip-left:before, .leaflet-tooltip-right:before, .leaflet-tooltip-top:before, .leaflet-tooltip-bottom:before { display: none; }
        
        /* Custom Marker Icons */
        .custom-marker-icon {
            background: transparent;
            border: none;
        }
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #fff;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        .marker-pin svg {
            transform: rotate(45deg); /* Correct icon rotation */
        }
        
        /* Pulse effect for user location (Domicile) */
        .user-pulse {
            background: rgba(59, 130, 246, 0.4);
            border-radius: 50%;
            height: 14px;
            width: 14px;
            position: absolute;
            left: 50%;
            top: 50%;
            margin: -7px 0 0 -7px;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <div class="app-container">
        <!-- Header -->
        <header class="bg-gradient-to-r from-amber-600 to-amber-700 text-white p-3 shadow-lg flex flex-col md:flex-row justify-between items-center shrink-0 gap-3 z-20">
            <div class="flex items-center gap-2 w-full md:w-auto">
                <i data-lucide="utensils-crossed" class="w-6 h-6 text-amber-200"></i>
                <div>
                    <h1 class="text-lg font-bold leading-none tracking-tight">Nancy Gourmand</h1>
                    <p class="text-[10px] text-amber-100 uppercase tracking-widest mt-0.5">Un guide savoureux</p>
                </div>
            </div>
            
            <!-- Category Filters -->
            <div class="flex gap-2 overflow-x-auto w-full md:w-auto pb-1 no-scrollbar items-center">
                <button onclick="setCategory('Tous')" id="btn-Tous" class="cat-btn active px-3 py-1.5 rounded-full text-xs font-bold transition-all border border-white/20 whitespace-nowrap">Tous</button>
                <button onclick="setCategory('Sal√©')" id="btn-Sal√©" class="cat-btn px-3 py-1.5 rounded-full text-xs font-bold transition-all border border-white/20 text-white whitespace-nowrap">ü•ß Sal√©</button>
                <button onclick="setCategory('Sucr√©')" id="btn-Sucr√©" class="cat-btn px-3 py-1.5 rounded-full text-xs font-bold transition-all border border-white/20 text-white whitespace-nowrap">üç∞ Sucr√©</button>
                <button onclick="setCategory('Mirabelle')" id="btn-Mirabelle" class="cat-btn px-3 py-1.5 rounded-full text-xs font-bold transition-all border border-white/20 text-amber-200 whitespace-nowrap">üåï Mirabelle</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden flex-col md:flex-row relative">
            
            <!-- Map View -->
            <div class="flex-1 relative bg-slate-200 h-1/2 md:h-full order-1 md:order-2">
                <div id="map"></div>
                
                <!-- Geolocation Button -->
                <button onclick="locateUser()" class="absolute bottom-4 right-4 bg-white p-3 rounded-full shadow-lg z-[500] text-slate-700 hover:text-blue-600 transition-colors active:scale-95 border border-slate-100">
                    <i id="locate-icon" data-lucide="crosshair" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- List View (Sidebar) -->
            <div class="w-full md:w-96 flex flex-col bg-white border-r border-slate-200 overflow-hidden shrink-0 h-1/2 md:h-full shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] md:shadow-none z-10 order-2 md:order-1 relative rounded-t-2xl md:rounded-none">
                
                <!-- Drag Handle -->
                <div class="md:hidden w-full flex justify-center pt-3 pb-1 bg-white rounded-t-2xl">
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
                </div>

                <!-- List Content -->
                <div id="locations-list" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar pb-20 md:pb-4 pt-2">
                    <!-- Near home message -->
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mb-2 shadow-sm flex items-start gap-3">
                        <div class="bg-blue-100 p-2 rounded-full shrink-0">
                            <i data-lucide="map-pin-house" class="w-4 h-4 text-blue-600"></i>
                        </div>
                        <div>
                            <p class="text-xs text-blue-800 font-bold">
                                Proche de chez vous (Rue d'Auxonne)
                            </p>
                            <p class="text-[11px] text-blue-600 mt-0.5 leading-tight">
                                La confiserie Lef√®vre-Lemoine est √† 12 min √† pied !
                            </p>
                        </div>
                    </div>
                    <!-- Items injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- DATA ---
        // Added 'icon' property for custom markers
        const locations = [
            // Sal√©
            { id: 1, name: "Sucr√©-Sal√©", cat: "Sal√©", specialty: "P√¢t√© Lorrain ü•á", address: "32 Rue du Faubourg des 3 Maisons", rating: 4.9, coords: [48.7025, 6.1775], description: "Vainqueur du 1er prix 2024. Le feuilletage est une r√©f√©rence absolue.", color: "#ea580c", hours: "07:00 - 19:30", icon: "chef-hat" },
            { id: 2, name: "Maison Schmidt", cat: "Sal√©", specialty: "P√¢t√© & Tourte", address: "55 Rue Saint-Georges", rating: 4.7, coords: [48.6920, 6.1860], description: "Feuilletage d'exception et Tourte Lorraine renomm√©e.", color: "#ea580c", hours: "07:00 - 19:00", icon: "utensils-crossed" },
            { id: 3, name: "Boulangerie G√©rard", cat: "Sal√©", specialty: "P√¢t√© Lorrain", address: "28 Av. du Mar√©chal Juin", rating: 4.6, coords: [48.6980, 6.1950], description: "R√©guli√®rement prim√©, une valeur s√ªre.", color: "#ea580c", hours: "06:30 - 19:30", icon: "croissant" },
            { id: 4, name: "Maison Jacquin", cat: "Sal√©", specialty: "P√¢t√© Rustique", address: "77 bis Rue Saint-Georges", rating: 4.5, coords: [48.6915, 6.1870], description: "Marinade tr√®s √©quilibr√©e, style traditionnel.", color: "#ea580c", hours: "07:30 - 19:00", icon: "wheat" },
            { id: 5, name: "Le Provost", cat: "Sal√©", specialty: "P√¢t√© & Fuseau", address: "28 Rue Raymond Poincar√©", rating: 4.8, coords: [48.6905, 6.1720], description: "Version bouch√®re g√©n√©reuse et fameux Fuseau Lorrain.", color: "#ea580c", hours: "08:00 - 19:15", icon: "beef" },
            { id: 6, name: "Traiteur Schaller", cat: "Sal√©", specialty: "Pot√©e Lorraine", address: "March√© Couvert (Centre)", rating: 4.7, coords: [48.6900, 6.1830], description: "Plats traiteurs authentiques au c≈ìur du march√©.", color: "#ea580c", hours: "08:00 - 18:00", icon: "soup" },

            // Sucr√©
            { id: 10, name: "S≈ìurs Macarons", cat: "Sucr√©", specialty: "Macarons & Baba", address: "21 Rue des S≈ìurs Macarons", rating: 4.9, coords: [48.6895, 6.1855], description: "D√©tenteurs du secret historique depuis 1793.", color: "#d946ef", hours: "09:30 - 19:00", icon: "cookie" },
            { id: 11, name: "Lef√®vre-Lemoine", cat: "Sucr√©", specialty: "Bergamotes", address: "47 Rue Henri-Poincar√©", rating: 4.9, coords: [48.6912, 6.1755], description: "Plus ancienne confiserie. D√©cor et produits 100% Art Nouveau.", color: "#d946ef", hours: "09:00 - 19:00", icon: "candy" },
            { id: 12, name: "P√¢tisserie Adam", cat: "Sucr√©", specialty: "G√¢teau Saint-Epvre", address: "3 Place Saint-Epvre", rating: 4.9, coords: [48.6948, 6.1795], description: "Le seul endroit au monde o√π acheter le vrai Saint-Epvre.", color: "#d946ef", hours: "08:00 - 19:30", icon: "cake-slice" },
            { id: 13, name: "Lalonde", cat: "Sucr√©", specialty: "Chardons", address: "20 Rue Saint-Jean", rating: 4.8, coords: [48.6910, 6.1810], description: "Les meilleurs Chardons (chocolats √† l'eau-de-vie). Couleurs vives.", color: "#d946ef", hours: "10:00 - 19:00", icon: "gem" },
            
            // Mirabelle
            { id: 20, name: "Maison Gwizdak", cat: "Mirabelle", specialty: "Tarte Mirabelle", address: "19 Rue Raugraff", rating: 4.6, coords: [48.6905, 6.1825], description: "Excellente p√¢tisserie pour les tartes aux fruits de saison.", color: "#facc15", hours: "06:30 - 19:00", icon: "cherry" }, // Using cherry as generic fruit
            { id: 21, name: "March√© Couvert", cat: "Mirabelle", specialty: "Fruits & Sirops", address: "Rue Claude Charles", rating: 4.6, coords: [48.6902, 6.1835], description: "Le spot pour trouver des Mirabelles fra√Æches ou au sirop.", color: "#facc15", hours: "08:00 - 18:00", icon: "shopping-basket" },
            { id: 22, name: "Alain Batt", cat: "Mirabelle", specialty: "Mirabelle Confite", address: "Rue Saint-Georges", rating: 4.5, coords: [48.6925, 6.1850], description: "Sp√©cialiste de la confiserie √† la mirabelle (s√©ch√©e, confite).", color: "#facc15", hours: "10:00 - 19:00", icon: "sun" }
        ];

        // Hardcoded Home Location (Approx Rue d'Auxonne near Gare)
        const homeLocation = { coords: [48.6880, 6.1730], label: "Domicile" };

        let currentCategory = 'Tous';
        let map;
        let markers = [];
        let selectedId = null;
        let userGeoMarker = null;

        function init() {
            lucide.createIcons();
            initMap();
            renderList();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([48.6937, 6.1810], 14);
            L.control.zoom({ position: 'topright' }).addTo(map);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Add Home Marker
            const homeIconHtml = `
                <div class="relative w-8 h-8 flex items-center justify-center">
                    <div class="bg-blue-100 rounded-full p-1.5 shadow-md border-2 border-white text-blue-600">
                        <i data-lucide="map-pin-house" class="w-4 h-4"></i>
                    </div>
                </div>`;
            
            const homeIcon = L.divIcon({
                className: 'custom-marker-icon',
                html: homeIconHtml,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const homeMarker = L.marker(homeLocation.coords, { icon: homeIcon }).addTo(map);
            homeMarker.bindTooltip("Domicile", { permanent: true, direction: "bottom", offset: [0, 8], className: "custom-tooltip text-blue-600" });

            updateMarkers();
        }

        function locateUser() {
            if (!navigator.geolocation) {
                alert("La g√©olocalisation n'est pas support√©e par votre navigateur.");
                return;
            }

            const btnIcon = document.getElementById('locate-icon');
            btnIcon.classList.add('animate-spin'); // Feedback

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Remove existing geo marker if any
                    if (userGeoMarker) {
                        map.removeLayer(userGeoMarker);
                    }

                    // Create Blue Dot Marker (GPS style)
                    const gpsIconHtml = `
                        <div class="relative w-8 h-8 flex items-center justify-center">
                            <div class="absolute w-full h-full bg-blue-500/40 rounded-full animate-ping"></div>
                            <div class="relative w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-md"></div>
                        </div>`;
                    
                    const gpsIcon = L.divIcon({
                        className: 'custom-marker-icon',
                        html: gpsIconHtml,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    userGeoMarker = L.marker([lat, lng], { icon: gpsIcon }).addTo(map);
                    userGeoMarker.bindTooltip("Ma position", { direction: "top", offset: [0, -10], className: "custom-tooltip text-blue-600 font-bold" });

                    map.flyTo([lat, lng], 16);
                    btnIcon.classList.remove('animate-spin');
                },
                (error) => {
                    console.error("Erreur de g√©olocalisation", error);
                    alert("Impossible de vous localiser. V√©rifiez que le GPS est activ√©.");
                    btnIcon.classList.remove('animate-spin');
                },
                { enableHighAccuracy: true }
            );
        }

        function setCategory(cat) {
            currentCategory = cat;
            
            // Buttons UI
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-amber-600', 'shadow-md');
                if(btn.id !== `btn-${cat}`) {
                     if(btn.id === 'btn-Mirabelle') btn.classList.add('text-amber-200');
                     else if (btn.id !== 'btn-Tous') btn.classList.add('text-white');
                }
            });

            const activeBtn = document.getElementById(`btn-${cat}`);
            activeBtn.classList.add('active', 'bg-white', 'text-amber-600', 'shadow-md');
            activeBtn.classList.remove('text-white', 'text-amber-200');

            renderList();
            updateMarkers();
        }

        function getFilteredData() {
            return locations.filter(loc => (currentCategory === 'Tous' || loc.cat === currentCategory));
        }

        function renderList() {
            const list = document.getElementById('locations-list');
            const data = getFilteredData();
            
            // Preserve home message
            const homeMsg = list.querySelector('.bg-blue-50');
            list.innerHTML = '';
            if (homeMsg) list.appendChild(homeMsg);

            data.forEach(loc => {
                const card = document.createElement('div');
                card.id = `card-${loc.id}`; // Add ID for scrolling
                const isSelected = selectedId === loc.id;
                card.className = `p-4 rounded-xl border transition-all cursor-pointer ${isSelected ? 'border-amber-500 bg-amber-50 shadow-sm ring-1 ring-amber-500' : 'border-slate-200 bg-white hover:border-amber-300'}`;
                
                let badgeClass = "bg-slate-100 text-slate-600";
                if(loc.cat === 'Sal√©') badgeClass = "bg-orange-100 text-orange-700";
                if(loc.cat === 'Sucr√©') badgeClass = "bg-pink-100 text-pink-700";
                if(loc.cat === 'Mirabelle') badgeClass = "bg-yellow-100 text-yellow-700";

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${badgeClass}">
                                ${loc.specialty}
                            </span>
                            <h3 class="font-bold text-slate-800 mt-1 text-base">${loc.name}</h3>
                        </div>
                        <div class="flex items-center text-amber-600 font-bold text-xs bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100">
                            ${loc.rating} <i data-lucide="star" class="w-3 h-3 ml-0.5 fill-current"></i>
                        </div>
                    </div>
                    <p class="text-sm text-slate-600 mt-2 leading-relaxed">${loc.description}</p>
                    <div class="flex flex-col gap-1 mt-3 pt-2 border-t border-dashed border-slate-200">
                         <p class="text-xs text-slate-500 flex items-center gap-2">
                            <i data-lucide="clock" class="w-3 h-3 text-amber-500"></i> ${loc.hours}
                        </p>
                        <p class="text-xs text-slate-400 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-3 h-3 text-amber-500"></i> ${loc.address}
                        </p>
                    </div>
                `;
                card.onclick = () => focusLocation(loc);
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        // Generate Custom Marker HTML
        function createCustomMarkerIcon(loc, isSelected) {
            const size = isSelected ? 40 : 30;
            const iconSize = isSelected ? 20 : 16;
            const zIndex = isSelected ? 50 : 10;
            
            // Determine icon color based on selection or category
            const bgColor = loc.color;

            return L.divIcon({
                className: 'custom-marker-icon',
                html: `
                    <div class="marker-pin" style="background-color: ${bgColor}; width: ${size}px; height: ${size}px; margin: -${size/2}px 0 0 -${size/2}px; z-index: ${zIndex};">
                        <i data-lucide="${loc.icon}" style="width: ${iconSize}px; height: ${iconSize}px; color: white;"></i>
                    </div>
                `,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }

        function updateMarkers() {
            // Re-draw all markers (clearing old ones first)
            // Note: User marker is NOT in the 'markers' array, so it stays.
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const data = getFilteredData();
            data.forEach(loc => {
                const isSelected = loc.id === selectedId;
                
                const marker = L.marker(loc.coords, {
                    icon: createCustomMarkerIcon(loc, isSelected),
                    id: loc.id
                }).addTo(map);

                marker.bindTooltip(
                    `${loc.name}`,
                    { 
                        permanent: true,
                        direction: 'top',
                        offset: [0, isSelected ? -20 : -15],
                        className: 'custom-tooltip',
                        opacity: 1
                    }
                );

                marker.on('click', () => {
                    focusLocation(loc);
                });
                markers.push(marker);
                
                if(isSelected) marker.setZIndexOffset(1000); // Ensure selected is on top
            });
            lucide.createIcons();
        }

        function focusLocation(loc) {
            selectedId = loc.id;
            
            // Pan map
            map.flyTo(loc.coords, 16, { duration: 1.0 });
            
            renderList();
            updateMarkers(); // Redraw to update marker sizes

            // Scroll Logic for Mobile & Desktop
            setTimeout(() => {
                const card = document.getElementById(`card-${loc.id}`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 50); // Small delay to ensure rendering is done
        }

        window.onload = init;
    </script>
</body>
</html>